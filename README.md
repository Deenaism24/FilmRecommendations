## Общий обзор

Я написала систему, основанную на моделях **TopPopular** и **Alternating Least Squares**, которая рекомендует фильмы конкретным пользователям. 

Проект включает данные, исходный код моделей, скрипты для обучения и применения моделей, а также ноутбуки для анализа данных и обучения моделей.

## Используемые библиотеки
```
from abc import ABC, abstractmethod
from typing import List, Dict
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import pickle
from implicit.als import AlternatingLeastSquares
from scipy.sparse import csr_matrix
from sklearn.preprocessing import LabelEncoder
from tqdm.auto import tqdm
```

- `abc `: используется для создания абстрактных классов.
- `typing`: применяется при аннотация типов.
- `numpy`:библиотека для работы с массивами и матрицами чисел. Используется для эффективных численных вычислений.
- `pandas`: основная библиотека для работы с данными в формате таблиц (DataFrame). Используется для чтения CSV-файлов, обработки и агрегации данных.
- `matplotlib`: библиотека для визуализации. Используется в EDA для построения графиков.
- `pickle`: модуль для сериализации и десериализации объектов Python. Используется для сохранения и загрузки обученных моделей.
- `implicit.als.AlternatingLeastSquares`: библиотека для построения рекомендаций на неявных данных. Предоставляет реализацию модели ALS.
- `scipy.sparse.csr_matrix`: модуль для работы с разреженными матрицами. Используется в модели ALS для хранения матрицы связи пользователей и фильмов.
- `sklearn.preprocessing.LabelEncoder`: используется для преобразования категориальных признаков (идентификаторов пользователей и фильмов) в числовые значения для работы с матрицами.
- `tqdm`: библиотека для отображения прогресса выполнения циклов.

## Описание файлов и их функциональности
### 1. Папка `data/`

Содержит следующие файлы с данными:

- `train_data.csv` — данные для обучения, содержащие информацию о просмотрах фильмов пользователями.  
- `test_data.csv` — данные для тестирования, на которых проверяется  модель.  
- `users_df.csv` — описание пользователей, которое может содержать дополнительную информацию о них.  
- `items_df.csv` — описание фильмов, содержащее их характеристики и другие полезные фичи.  
- `countries.csv`, `genres.csv`, `staff.csv` - вспомогательные данные.

### 2. Папка `notebooks/`

- `eda.ipynb` - для загрузки и анализа данных при обучении моделей.
- `model_training.ipynb` - для обучения моделей и оценки их качества.

### 3. Директория `src/`

Содержит исходный код моделей и функций для оценки:
- `models.py`: реализует базовые классы и конкретные модели рекомендаций.
- `evaluation.py`: описывает функции для оценки качества рекомендаций.

### 4. Файл `main.py`

Главный скрипт для запуска обучения моделей и получения рекомендаций для конкретного пользователя.

### 5. Директория `saved_models/`

Сохраненные модели после обучения:
- `ALS_model.pkl`: обученная модель с использованием ALS.
- `best_model`: лучшая по оценке из двух моделей при обучении.
---
#### Функции:

**main()**:
   - Загружает данные для обучения и тестирования.
   - Создает экземпляр модели ALS с заданными параметрами или экземпляр модели TopPopular.
   - Обучает модель на обучающих данных.
   - Генерирует рекомендации для тестовых пользователей.
   - Оценивает качество рекомендаций с помощью функции `evaluate_recommender`.
   - Сохраняет обученную модель в файл `ALS_model.pkl` или `TP_model.pkl` соответственно.
#### Приемы для обучения:

- Используется модель ALS из библиотеки `implicit`, которая предназначена для построения рекомендаций на неявных данных.
- Модель TopPopular рекомендует самые популярные фильмы на основе частоты их просмотра в обучающих данных.
- Параметры модели (итерации, число факторов и т.д.) настроены для достижения лучшей производительности.

### `test_recomendations.py`

**get_recommendations_for_user(user_id, model_path, topn)**:
   - Загружает обученную модель из файла `model_path`.
   - Генерирует рекомендации для заданного пользователя user_id.
   - Загружает информацию о фильмах из `items_df.csv`.
   - Выводит названия `topn` рекомендованных фильмов.

### `src/models.py`

#### Классы:

1. **BaseRecommender (абстрактный класс)**:
   - Определяет общий интерфейс для моделей рекомендаций.
   - Методы `fit` и `predict` являются абстрактными и реализованы в подклассах.

2. **TopPopular (наследуется от BaseRecommender)**:
   - Метод `fit` вычисляет самые популярные фильмы по числу просмотров.
   - Метод `predict` возвращает `topn` популярных фильмов для каждого пользователя.

3. **ALS (наследуется от BaseRecommender)**:
   - Инициализирует модель ALS с заданными параметрами.
   - Метод `fit`:
     - Кодирует идентификаторы пользователей и фильмов с помощью `LabelEncoder`.
     - Создает разреженную матрицу взаимодействий.
     - Обучает модель ALS.
   - Метод `predict`:
     - Для каждого пользователя генерирует рекомендации с помощью метода `recommend` модели ALS.
     - Декодирует идентификаторы фильмов обратно в исходные значения.

#### Приемы для обучения:

- Использование разреженных матриц для эффективного хранения данных.
- Кодирование идентификаторов для удобства работы с матрицами.
- Параллельное вычисление рекомендаций с отображением прогресса с помощью библиотеки `tqdm`.

### `src/evaluation.py`

#### Возможные функции:

- `ndcg_metric(gt_items: np.ndarray, predicted: np.ndarray)`: вычисляет метрику NDCG для заданных истинных значений и предсказанных значений.
- `dcg(scores: np.ndarray)`: вычисляет DCG для заданных оценок.
- `ecall_metric(gt_items: np.ndarray, predicted: np.ndarray)`: вычисляет метрику Recall для истинных значений предсказанных значений.
- `evaluate_recommender(df: pd.DataFrame, model_preds_col: str, gt_col: str = "movie_id")`: оценивает рекомендательную систему на основе данных в DataFrame, используя столбец с предсказаниями модели и столбец с истинными значениями. Возвращает словарь с средними значениями метрик NDCG и Recall.

#### Приемы для обучения:

- Использование множеств для вычисления пересечений между списками истинных и предсказанных элементов.
- Проверка и обработка пропущенных значений и аномалий в данных перед вычислением метрик.
- Использование генераторов для итерации по данным, что позволяет экономить память при работе с большими наборами данных.
- Применение кросс-валидации для оценки стабильности и обобщающей способности модели.

## Ноутбуки для анализа и обучения

### `notebooks/eda.ipynb`

- Импортирует данные из файлов CSV.
- Выводит статистическое описание данных с помощью `describe()`.
- Строит графики распределения признаков при необходимости.

### `notebooks/model_training.ipynb`

1. **Обучение модели TopPopular**:
   - Создает экземпляр модели `TopPopular`.
   - Обучает модель на данных.
   - Генерирует рекомендации для тестовых пользователей.
   - Оценивает качество рекомендаций с помощью `evaluate_recommender`.
   - Выводит метрики качества.

2. **Обучение модели ALS**:
   - Создает экземпляр модели `ALS` с заданными параметрами.
   - Обучает модель на данных.
   - Генерирует рекомендации для тестовых пользователей.
   - Оценивает качество рекомендаций.
   - Выводит метрики качества.

3. **Сравнение моделей**:
   - Сравнивает метрики моделей.
   - Выводит графики зависимости рекомендаций от модели.
   
4. **Сохранение лучшей модели**:
   - Сохраняет лучшую модель в файл `best_model.pkl`.


## Главный скрипт `main.py`

- Импортирует функции `get_recommendations_for_user` из `test_recomendations.py`.
- Определяет функцию `main()`, которая:
  - Запускает работу моделей `ALS` или `TopPopular`.
  - Вызывает функции получения рекомендаций для заданного пользователя.

---

### Модель TopPopular:

- **Описание**: простая модель, которая рекомендует самые популярные фильмы на основе их частоты в обучающих данных.
- **Обучение**: вычисление количества просмотров каждого фильма и сортировка фильмов по убыванию популярности.
- **Преимущества**: простота реализации, быстрая скорость работы.

### Модель ALS (Alternating Least Squares):

- **Описание**: факторизационная модель, которая раскладывает матрицу связи пользователей и фильмов на произведение двух матриц меньшей размерности.
- **Обучение**:
  - Создание разреженной матрицы взаимодействий на основе обучающих данных.
  - Использование алгоритма ALS для факторизации матрицы.
  - Параметры модели настроены для оптимизации качества рекомендаций.
- **Преимущества**:
  - Учитывает как предпочтения пользователей, так и свойства фильмов.
  - Может масштабироваться на большие данные при использовании разреженных матриц.

---

## Заключение

Проект представляет собой систему рекомендаций фильмов. Две модели: TopPopular и ALS обучаются на одних данных, что позволяет корректно оценить и выбрать подходящую модель для работы. На исходных данных модель ALS показала лучшие результаты в сравнении с TopPopular, на что указывало разнообразие рекомендаций фильмов на обучающих данных. Поэтому модель ALS ыла выбрана и использована на тестовых данных. 